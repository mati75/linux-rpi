commit 9d028c09d1cf21b33030e137905846c8bebea768
Author: Emily Deng <Emily.Deng@amd.com>
Date:   Wed Aug 22 20:18:25 2018 +0800

    amdgpu: fix multi-process hang issue
    
    [ Upstream commit 2f40c6eac74a2a60921cdec9e9a8a57e88e31434 ]
    
    SWDEV-146499: hang during multi vulkan process testing
    
    cause:
    the second frame's PREAMBLE_IB have clear-state
    and LOAD actions, those actions ruin the pipeline
    that is still doing process in the previous frame's
    work-load IB.
    
    fix:
    need insert pipeline sync if have context switch for
    SRIOV (because only SRIOV will report PREEMPTION flag
    to UMD)
    
    Signed-off-by: Monk Liu <Monk.Liu@amd.com>
    Signed-off-by: Emily Deng <Emily.Deng@amd.com>
    Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_ib.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_ib.c
index 7aaa263ad8c7..6b5d4a20860d 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_ib.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_ib.c
@@ -164,8 +164,10 @@ int amdgpu_ib_schedule(struct amdgpu_ring *ring, unsigned num_ibs,
 		return r;
 	}
 
+	need_ctx_switch = ring->current_ctx != fence_ctx;
 	if (ring->funcs->emit_pipeline_sync && job &&
 	    ((tmp = amdgpu_sync_get_fence(&job->sched_sync, NULL)) ||
+	     (amdgpu_sriov_vf(adev) && need_ctx_switch) ||
 	     amdgpu_vm_need_pipeline_sync(ring, job))) {
 		need_pipe_sync = true;
 		dma_fence_put(tmp);
@@ -196,7 +198,6 @@ int amdgpu_ib_schedule(struct amdgpu_ring *ring, unsigned num_ibs,
 	}
 
 	skip_preamble = ring->current_ctx == fence_ctx;
-	need_ctx_switch = ring->current_ctx != fence_ctx;
 	if (job && ring->funcs->emit_cntxcntl) {
 		if (need_ctx_switch)
 			status |= AMDGPU_HAVE_CTX_SWITCH;
diff -uN a/1.txt b/1.txt
--- a/dummy/rpi_1276_9d028c09d1cf21b33030e137905846c8bebea768.txt	1970-01-01 00:00:00.000000000 +0000
+++ b/dummy/rpi_1276_9d028c09d1cf21b33030e137905846c8bebea768.txt	2013-12-23 04:07:40.000000000 +0000
@@ -0,0 +1 @@
+dummy file to ensure patch has content.
